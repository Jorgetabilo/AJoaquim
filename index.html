<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumbar Fusion ASD Risk Calculator</title>
    <!-- Load Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load React and ReactDOM from CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Load Babel Standalone to transpile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Custom Styles -->
    <style>
        /* Define Inter font for the entire application */
        body {
            font-family: 'Inter', sans-serif;
            box-sizing: border-box; /* Ensure padding and border are included in total size */
        }
        /* Styles for custom modal overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }
        /* Styles for custom modal content */
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-width: 90%;
            width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Main App component
        const App = () => {
            // State to manage the current view: 'intro', 'form', 'results'
            const [currentView, setCurrentView] = React.useState('intro');
            // State to store the selected values for each variable
            const [variables, setVariables] = React.useState({
                age: '0',
                genderMenopause: '0',
                preexistingDiscDegeneration: '0',
                unfavorableAnatomy: '0',
                geneticPredisposition: '0',
                elevatedBMI: '0',
                activeSmoking: '0',
                osteoporosis: '0',
                uncontrolledDiabetes: '0',
                fusedLevels: '0',
                distalFusionLevel: '0',
                adjacentLaminectomy: '0',
                suboptimalSagittalAlignment: '0',
                adjacentFacetViolation: '0',
                muscleLigamentDamage: '0',
            });
            // State to store the calculated risk score
            const [riskScore, setRiskScore] = React.useState(0);
            // State to store the risk category and percentage
            const [riskCategory, setRiskCategory] = React.useState('');
            const [estimatedPercentage, setEstimatedPercentage] = React.useState('');
            // State to store personalized recommendations
            const [recommendations, setRecommendations] = React.useState([]);

            // State to store the generated detailed recommendations
            const [detailedRecommendations, setDetailedRecommendations] = React.useState('');
            // State to manage loading status for generation
            const [isGeneratingDetailedRecommendations, setIsGeneratingDetailedRecommendations] = React.useState(false);

            // Function to navigate between views
            const navigateTo = (view) => {
                setCurrentView(view);
            };

            // Function to handle changes in form inputs
            const handleVariableChange = (name, value) => {
                setVariables(prev => ({ ...prev, [name]: value }));
            };

            // Data structure for variables and their points with detailed technical descriptions
            const variableDefinitions = [
                {
                    id: 'age',
                    name: 'Age',
                    type: 'non-modifiable',
                    options: [
                        { label: '<45 years', value: '0', points: 0 },
                        { label: '45–60 years', value: '1', points: 1 },
                        { label: '>60 years', value: '2', points: 2 },
                    ],
                    evidence: 'Sears et al., 2011; Hashimoto et al., 2019',
                    description: "Advanced age correlates with decreased cellularity of the nucleus pulposus, cellular senescence, and a shift towards a catabolic state in the intervertebral disc. Reduced proteoglycan synthesis and impaired endplate vascular supply compromise the disc's nutritional pathways and its ability to withstand biomechanical stress, accelerating degenerative changes at segments adjacent to a rigid fusion."
                },
                {
                    id: 'genderMenopause',
                    name: 'Gender and Menopause',
                    type: 'non-modifiable',
                    options: [
                        { label: 'Male', value: '0', points: 0 },
                        { label: 'Premenopausal Woman', value: '1', points: 1 },
                        { label: 'Postmenopausal Woman', value: '2', points: 2 },
                    ],
                    evidence: 'Huang et al., 2025',
                    description: "Postmenopausal estrogen deficiency is a critical factor. Estrogen modulates bone turnover via the RANKL/OPG pathway and has protective effects on the disc matrix. Its decline leads to increased bone resorption, systemic inflammation, and accelerated disc degeneration, making postmenopausal women more susceptible to subsidence, endplate fractures, and subsequent adjacent segment failure."
                },
                {
                    id: 'preexistingDiscDegeneration',
                    name: 'Pre-existing Adjacent Disc Degeneration',
                    type: 'non-modifiable',
                    options: [
                        { label: 'No', value: '0', points: 0 },
                        { label: 'Yes (documented on imaging)', value: '1', points: 3 },
                    ],
                    evidence: 'Masevnin et al., 2015',
                    description: "The presence of pre-existing degeneration (e.g., Pfirrmann grade ≥3, Modic changes) signifies a biomechanically compromised segment. A rigid fusion construct eliminates motion at the fused levels, causing a concentration of stress and compensatory hypermobility at the adjacent mobile segment. A disc that is already degenerated lacks the physiological resilience to adapt to this increased load, leading to accelerated structural failure and clinical symptoms."
                },
                {
                    id: 'unfavorableAnatomy',
                    name: 'Unfavorable Anatomical Characteristics (High PI, Mismatch)',
                    type: 'non-modifiable',
                    options: [
                        { label: 'PI ≤55° and PI-LL mismatch ≤10°', value: '0', points: 0 },
                        { label: 'PI >55° or mismatch >10°', value: '1', points: 2 },
                    ],
                    evidence: 'Wang et al., 2024',
                    description: "Pelvic Incidence (PI) is a key morphological parameter dictating the required lumbar lordosis (LL). A high PI necessitates a greater LL to maintain sagittal balance. A significant PI-LL mismatch (>10°) forces compensatory mechanisms such as pelvic retroversion and thoracic hypokyphosis. These compensations are energetically inefficient and place chronic abnormal stress on the unfused segments, particularly the disc and facet joints, predisposing them to ASD."
                },
                {
                    id: 'geneticPredisposition',
                    name: 'Known Genetic Predisposition',
                    type: 'non-modifiable',
                    options: [
                        { label: 'No', value: '0', points: 0 },
                        { label: 'Yes', value: '1', points: 2 },
                    ],
                    evidence: 'Omair et al., 2016',
                    description: "Genetic factors, such as polymorphisms in genes related to matrix metalloproteinases (MMPs), aggrecan, collagen, and inflammatory cytokines (e.g., IL-1, TNF-α), can determine an individual's intrinsic susceptibility to disc degeneration. A pro-inflammatory genetic background can lead to a more aggressive degenerative cascade in response to the altered biomechanics post-fusion."
                },
                {
                    id: 'elevatedBMI',
                    name: 'Elevated BMI (>30)',
                    type: 'modifiable',
                    options: [
                        { label: 'No', value: '0', points: 0 },
                        { label: 'Yes', value: '1', points: 2 },
                    ],
                    evidence: 'Ou et al., 2015; Lau et al., 2021',
                    description: "Obesity contributes to ASD through two primary mechanisms. Mechanically, it increases the axial load across the spine, magnifying stresses at the adjacent segment. Metabolically, adipose tissue is an active endocrine organ that secretes pro-inflammatory adipokines (e.g., leptin, TNF-α), creating a systemic inflammatory state that can accelerate cartilage and disc degradation."
                },
                {
                    id: 'activeSmoking',
                    name: 'Active Smoking',
                    type: 'modifiable',
                    options: [
                        { label: 'No', value: '0', points: 0 },
                        { label: 'Yes', value: '1', points: 1 },
                    ],
                    evidence: 'Huang et al., 2025',
                    description: "Nicotine-induced vasoconstriction impairs microcirculation through the vertebral endplates, which is the primary nutritional pathway for the avascular disc. This leads to cellular hypoxia, nutrient deprivation, and accumulation of metabolic waste. Smoking also inhibits fibroblast proliferation and collagen synthesis, directly impairing the disc's ability to repair its matrix, and promotes a pro-inflammatory state."
                },
                {
                    id: 'osteoporosis',
                    name: 'Osteoporosis (T-score < –2.5)',
                    type: 'modifiable',
                    options: [
                        { label: 'No', value: '0', points: 0 },
                        { label: 'Yes', value: '1', points: 2 },
                    ],
                    evidence: 'Hashimoto et al., 2019',
                    description: "Poor bone quality (low Bone Mineral Density and altered microarchitecture) compromises the structural integrity of the vertebral bodies. This increases the risk of instrumentation failure (e.g., decreased pedicle screw pullout strength) and interbody cage subsidence. Subsidence leads to a loss of sagittal correction, foraminal stenosis, and a transfer of load to the posterior elements of the adjacent segment, accelerating facet arthropathy and disc degeneration."
                },
                {
                    id: 'uncontrolledDiabetes',
                    name: 'Poorly Controlled Diabetes (HbA1c >7%)',
                    type: 'modifiable',
                    options: [
                        { label: 'No', value: '0', points: 0 },
                        { label: 'Yes', value: '1', points: 1 },
                    ],
                    evidence: 'Huang et al., 2025',
                    description: "Chronic hyperglycemia leads to the formation of Advanced Glycation End-products (AGEs), which accumulate in collagen-rich tissues like the annulus fibrosus, causing increased stiffness and brittleness. Diabetes-associated microangiopathy can also impair endplate perfusion, further compromising disc health. The overall pro-inflammatory and impaired healing environment in poorly controlled diabetes exacerbates degenerative processes."
                },
                {
                    id: 'fusedLevels',
                    name: 'Number of Fused Levels',
                    type: 'modifiable',
                    options: [
                        { label: '1 level', value: '0', points: 0 },
                        { label: '2 levels', value: '1', points: 1 },
                        { label: '≥3 levels', value: '2', points: 2 },
                    ],
                    evidence: 'Sears et al., 2011',
                    description: "The length of the fusion construct is directly proportional to the magnitude of stress transferred to the adjacent mobile segments. A long fusion creates a significant lever arm, concentrating substantial flexion-extension, lateral bending, and axial rotation forces at the first unfused level, which must compensate for the lost motion of the entire fused segment."
                },
                {
                    id: 'distalFusionLevel',
                    name: 'Distal Fusion Level',
                    type: 'modifiable',
                    options: [
                        { label: 'Fusion to sacrum', value: '0', points: 0 },
                        { label: 'Floating (ends at L5)', value: '1', points: 2 },
                    ],
                    evidence: 'Sears et al., 2011',
                    description: "A floating fusion ending at L5 places the highly mobile L5-S1 segment at significant risk. This segment is subjected to the highest biomechanical loads in the lumbar spine. Terminating a rigid construct just above it concentrates all the supracervical forces onto a segment that is already anatomically predisposed to degeneration, greatly increasing the likelihood of ASD at L5-S1."
                },
                {
                    id: 'adjacentLaminectomy',
                    name: 'Unfused Adjacent Laminectomy',
                    type: 'modifiable',
                    options: [
                        { label: 'No', value: '0', points: 0 },
                        { label: 'Yes', value: '1', points: 2 },
                    ],
                    evidence: 'Sears et al., 2011; Pinto et al., 2021',
                    description: "An adjacent-level laminectomy without fusion destabilizes the posterior column by resecting the spinous process and lamina, and potentially damaging the posterior ligamentous complex (PLC). This iatrogenic instability, combined with the increased stress from the adjacent fusion, leads to abnormal kinematics and accelerated degeneration of the decompressed but unfused segment."
                },
                {
                    id: 'suboptimalSagittalAlignment',
                    name: 'Suboptimal Sagittal Alignment',
                    type: 'modifiable',
                    options: [
                        { label: 'No', value: '0', points: 0 },
                        { label: 'Yes', value: '1', points: 2 },
                    ],
                    evidence: 'Rothenfluh et al., 2015; Wang et al., 2024',
                    description: "Failure to restore adequate lumbar lordosis (PI-LL mismatch >10°) results in positive sagittal imbalance. The patient must expend significant energy via posterior paraspinal muscles to maintain an upright posture, leading to muscle fatigue and pain. This imbalance shifts the primary load-bearing axis anteriorly, overloading the anterior column of the adjacent segment and driving degenerative disc changes."
                },
                {
                    id: 'adjacentFacetViolation',
                    name: 'Adjacent Facet Violation',
                    type: 'modifiable',
                    options: [
                        { label: 'No', value: '0', points: 0 },
                        { label: 'Yes', value: '1', points: 1 },
                    ],
                    evidence: 'Lau et al., 2021',
                    description: "Iatrogenic injury to the facet capsule or articular surface of the superior adjacent segment (e.g., during pedicle screw placement) disrupts the joint's integrity. The facet joints are critical for resisting rotational and shear forces. Damage to the capsule leads to instability, while damage to the cartilage initiates traumatic arthritis, both culminating in accelerated facet arthropathy and ASD."
                },
                {
                    id: 'muscleLigamentDamage',
                    name: 'Significant Muscle or Ligament Damage',
                    type: 'modifiable',
                    options: [
                        { label: 'No', value: '0', points: 0 },
                        { label: 'Yes', value: '1', points: 1 },
                    ],
                    evidence: 'Jokeit et al., 2025',
                    description: "Extensive dissection and retraction of paraspinal muscles (e.g., multifidus) in traditional open approaches can lead to denervation, atrophy, and fatty infiltration. These muscles are key dynamic stabilizers of the spine. Their functional loss compromises segmental stability, increases intradiscal pressure, and transfers excessive load to the passive structures (disc and facets) of the adjacent segment, promoting degeneration."
                },
            ];

            // Function to calculate the risk score and determine category/percentage
            const calculateRisk = () => {
                let totalScore = 0;
                const activeRecommendations = [];

                variableDefinitions.forEach(variableDef => {
                    const selectedValue = variables[variableDef.id];
                    const selectedOption = variableDef.options.find(opt => opt.value === selectedValue);
                    if (selectedOption) {
                        totalScore += selectedOption.points;

                        // Add recommendations for modifiable factors if they contributed points
                        if (variableDef.type === 'modifiable' && selectedOption.points > 0) {
                            switch (variableDef.id) {
                                case 'elevatedBMI':
                                    activeRecommendations.push("Optimize weight before surgery (BMI reduction >5%).");
                                    break;
                                case 'activeSmoking':
                                    activeRecommendations.push("Reinforce smoking cessation.");
                                    break;
                                case 'osteoporosis':
                                    activeRecommendations.push("Initiate preoperative anti-resorptive treatment for osteoporosis.");
                                    break;
                                case 'uncontrolledDiabetes':
                                    activeRecommendations.push("Intensive glycemic control pre- and post-operatively.");
                                    break;
                                case 'distalFusionLevel':
                                    activeRecommendations.push("Consider extending fusion to the sacrum if L5–S1 already has degeneration.");
                                    break;
                                case 'adjacentLaminectomy':
                                    activeRecommendations.push("Avoid adjacent laminectomy without stabilizing fixation.");
                                    break;
                                case 'suboptimalSagittalAlignment':
                                    activeRecommendations.push("Plan strict sagittal correction, PI-LL mismatch <10°.");
                                    break;
                                case 'muscleLigamentDamage':
                                    activeRecommendations.push("Use MIS technique to preserve musculature and ligaments.");
                                    break;
                                default:
                                    break;
                            }
                        }
                    }
                });

                setRiskScore(totalScore);
                setRecommendations(activeRecommendations);
                setDetailedRecommendations('');

                // Determine category and percentage
                if (totalScore >= 0 && totalScore <= 6) {
                    setRiskCategory('Low');
                    setEstimatedPercentage('~5–10%');
                } else if (totalScore >= 7 && totalScore <= 12) {
                    setRiskCategory('Moderate');
                    setEstimatedPercentage('~10–25%');
                } else if (totalScore > 12) {
                    setRiskCategory('High');
                    setEstimatedPercentage('>25%');
                }

                navigateTo('results');
            };

            // Function to generate detailed recommendations locally
            const generateOfflineDetailedRecommendations = () => {
                setIsGeneratingDetailedRecommendations(true);
                setDetailedRecommendations('Generating detailed recommendations...');

                let generatedText = `Based on a risk score of ${riskScore} (${riskCategory} Risk), the following areas should be prioritized for mitigation:\n\n`;

                if (recommendations.length === 0) {
                    generatedText += "No specific modifiable risk factors were identified that contributed points to the score. General best practices for spinal fusion should be followed, including careful preservation of adjacent level anatomy and optimization of the patient's overall health.\n";
                } else {
                    recommendations.forEach(rec => {
                        if (rec.includes("osteoporosis")) {
                            generatedText += `**Management of Osteoporosis:**\n`;
                            generatedText += `The presence of osteoporosis (T-score < -2.5) is a critical determinant of mechanical failure. Poor bone quality compromises the screw-bone interface, increasing the risk of screw loosening, and can lead to cage subsidence into the weak vertebral endplates. This subsidence results in a loss of achieved sagittal correction and foraminal height. \n\n*Actionable Steps:*\n- Initiate preoperative anti-resorptive therapy (e.g., bisphosphonates, denosumab) at least 3-6 months before elective surgery.\n- Ensure supplementation with Calcium and Vitamin D.\n- Consider cement augmentation of pedicle screws (fenestrated screws) to significantly improve pullout strength in osteoporotic bone.\n- Counsel the patient on the lifelong need for osteoporosis management.\n\n`;
                        }
                        if (rec.includes("sagittal correction")) {
                            generatedText += `**Achieving Optimal Sagittal Alignment:**\n`;
                            generatedText += `Failure to restore sagittal balance (PI-LL mismatch > 10°) is a primary driver of both mechanical failure and poor clinical outcomes. An anteriorly shifted sagittal vertical axis (SVA) forces compensatory pelvic retroversion, which is metabolically demanding and places chronic overload on the posterior musculature and adjacent unfused segments. \n\n*Actionable Steps:*\n- Perform meticulous preoperative planning with full-spine standing X-rays to calculate PI, LL, and other parameters.\n- Utilize techniques to maximize lordosis, such as appropriate selection of lordotic interbody cages, posterior release maneuvers (e.g., Ponte osteotomy), and proper rod contouring and compression techniques.\n- The goal is to restore a PI-LL mismatch to <10° and a balanced SVA to place the patient back within their 'cone of economy'.\n\n`;
                        }
                        if (rec.includes("weight")) {
                            generatedText += `**Body Mass Index (BMI) Optimization:**\n`;
                            generatedText += `An elevated BMI (>30) acts as both a mechanical and metabolic risk factor. Increased axial loading magnifies stress at the adjacent segment. Furthermore, adipose tissue secretes inflammatory adipokines (e.g., TNF-α, IL-6), which create a systemic pro-inflammatory environment that can accelerate disc degeneration. \n\n*Actionable Steps:*\n- Preoperative referral to a nutritionist or weight management program is strongly advised.\n- A target of 5-10% body weight loss can significantly reduce both mechanical and inflammatory stress on the spine.\n\n`;
                        }
                        if (rec.includes("smoking")) {
                            generatedText += `**Smoking Cessation:**\n`;
                            generatedText += `Smoking is profoundly detrimental to spinal health. Nicotine's vasoconstrictive effects critically impair nutrient delivery to the avascular disc via the endplates. It also inhibits osteoblast function, directly impairing fusion, and has been shown to accelerate the catabolic processes within the disc matrix. \n\n*Actionable Steps:*\n- Mandate smoking cessation for at least 4-6 weeks preoperatively and indefinitely post-op.\n- Provide resources such as nicotine replacement therapy and counseling.\n\n`;
                        }
                        if (rec.includes("MIS technique")) {
                            generatedText += `**Preservation of Musculoligamentous Structures:**\n`;
                            generatedText += `The posterior tension band, composed of the paraspinal muscles (especially the multifidus) and the posterior ligamentous complex, is a crucial dynamic stabilizer. Traditional open approaches with wide muscle stripping can lead to iatrogenic denervation, atrophy, and fatty infiltration, compromising this stability. \n\n*Actionable Steps:*\n- Employ minimally invasive surgery (MIS) techniques, such as a paraspinal approach (e.g., Wiltse) or tubular retractors, to minimize muscle damage.\n- Careful preservation of the supraspinous and interspinous ligaments and the facet capsules at the adjacent level is paramount.\n\n`;
                        }
                         if (rec.includes("extending fusion to the sacrum")) {
                            generatedText += `**Strategy for Distal Fusion Level:**\n`;
                            generatedText += `Terminating a long fusion at L5 ("floating fusion") concentrates immense biomechanical stress on the L5-S1 disc, which is already the most loaded segment in the lumbar spine. If the L5-S1 disc shows pre-existing significant degeneration (e.g., Pfirrmann grade >3, loss of height, instability), it is unlikely to withstand this increased load. \n\n*Actionable Steps:*\n- Carefully evaluate the preoperative MRI for the status of the L5-S1 disc.\n- If significant degeneration exists, extending the fusion to the sacrum (with or without iliac fixation depending on the length of the construct and bone quality) is strongly recommended to protect this vulnerable segment and prevent near-certain adjacent segment failure.\n\n`;
                        }
                    });
                }
                
                // Use a short timeout to simulate generation and allow the UI to update
                setTimeout(() => {
                    setDetailedRecommendations(generatedText);
                    setIsGeneratingDetailedRecommendations(false);
                }, 500);
            };

            // Dynamic loading of html2canvas and jspdf for PDF export
            React.useEffect(() => {
                const loadScript = (src) => {
                    return new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = src;
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                };

                const loadScripts = async () => {
                    if (currentView === 'results' && typeof window.html2canvas === 'undefined') {
                        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
                        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
                    }
                };
                loadScripts();
            }, [currentView]);

            const exportPdf = async () => {
                const input = document.getElementById('result-content');
                if (!input) {
                    console.error("Element with ID 'result-content' not found.");
                    return;
                }
                try {
                    const canvas = await window.html2canvas(input, { scale: 2 });
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: 'portrait',
                        unit: 'px',
                        format: [canvas.width, canvas.height]
                    });
                    pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                    pdf.save('asd_risk_report.pdf');
                } catch (error) {
                    console.error("Error generating PDF:", error);
                    const messageBox = document.createElement('div');
                    messageBox.className = 'modal-overlay';
                    messageBox.innerHTML = `
                        <div class="modal-content text-center">
                            <p class="text-lg text-red-600 mb-4">There was an error generating the PDF. Please try again.</p>
                            <button id="closeMessageBox" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Close</button>
                        </div>
                    `;
                    document.body.appendChild(messageBox);
                    document.getElementById('closeMessageBox').onclick = () => document.body.removeChild(messageBox);
                }
            };
            
            const shareByEmail = () => {
                const subject = encodeURIComponent('Lumbar Fusion ASD Risk Report');
                const body = encodeURIComponent(`
                Dear colleague,

                Attached is the Adjacent Segment Disease (ASD) risk report for a patient, calculated using the specialized application.

                Risk Score: ${riskScore} points
                Risk Category: ${riskCategory}
                Estimated 5-year Risk Percentage: ${estimatedPercentage}

                Personalized Recommendations:
                ${recommendations.length > 0 ? recommendations.map(rec => `- ${rec}`).join('\n') : 'No specific recommendations identified based on modifiable factors.'}

                ${detailedRecommendations ? `\nDetailed Recommendations:\n${detailedRecommendations}` : ''}

                Selected Variable Details:
                ${Object.keys(variables).map(key => {
                    const varDef = variableDefinitions.find(def => def.id === key);
                    const selectedOption = varDef.options.find(opt => opt.value === variables[key]);
                    return `${varDef.name}: ${selectedOption ? selectedOption.label : 'N/A'} (Points: ${selectedOption ? selectedOption.points : 0})`;
                }).join('\n')}

                Regards,
                [Your Name]
                `);
                window.location.href = `mailto:?subject=${subject}&body=${body}`;
            };


            return (
                <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4 font-sans">
                    <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl">
                        {currentView === 'intro' && (
                            <IntroScreen onStart={() => navigateTo('form')} />
                        )}

                        {currentView === 'form' && (
                            <RiskForm
                                variables={variables}
                                variableDefinitions={variableDefinitions}
                                onVariableChange={handleVariableChange}
                                onCalculate={calculateRisk}
                                onBack={() => navigateTo('intro')}
                            />
                        )}

                        {currentView === 'results' && (
                            <ResultScreen
                                riskScore={riskScore}
                                riskCategory={riskCategory}
                                estimatedPercentage={estimatedPercentage}
                                recommendations={recommendations}
                                detailedRecommendations={detailedRecommendations}
                                isGeneratingDetailedRecommendations={isGeneratingDetailedRecommendations}
                                onGenerateDetailedRecommendations={generateOfflineDetailedRecommendations}
                                onBack={() => navigateTo('form')}
                                onExportPdf={exportPdf}
                                onShareByEmail={shareByEmail}
                            />
                        )}
                    </div>
                </div>
            );
        };

        // IntroScreen Component
        const IntroScreen = ({ onStart }) => (
            <div className="text-center">
                <h1 className="text-3xl font-bold text-gray-800 mb-2 rounded-md">Lumbar Fusion ASD Risk Calculator</h1>
                 <p className="text-md font-medium text-gray-600 mb-4">
                    By Dr. Jorge Tabilo & Dr. Andrei Joaquim
                </p>
                <p className="text-gray-600 mb-6">
                    This application is designed for spine surgeons, allowing them to calculate and categorize the individual risk of Adjacent Segment Disease (ASD) after lumbar fusion, based on systematic evidence from 2010 to 2025.
                </p>
                <button
                    onClick={onStart}
                    className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105"
                >
                    Calculate Risk
                </button>
            </div>
        );

        // RiskForm Component
        const RiskForm = ({ variables, variableDefinitions, onVariableChange, onCalculate, onBack }) => (
            <div>
                <h2 className="text-2xl font-semibold text-gray-800 mb-6 text-center rounded-md">ASD Risk Factors</h2>

                <div className="mb-8">
                    <h3 className="text-xl font-medium text-orange-600 mb-4">Non-Modifiable Factors</h3>
                    {variableDefinitions.filter(v => v.type === 'non-modifiable').map(variable => (
                        <VariableInput
                            key={variable.id}
                            variable={variable}
                            selectedValue={variables[variable.id]}
                            onChange={onVariableChange}
                        />
                    ))}
                </div>

                <div className="mb-8">
                    <h3 className="text-xl font-medium text-green-600 mb-4">Modifiable Factors</h3>
                    {variableDefinitions.filter(v => v.type === 'modifiable').map(variable => (
                        <VariableInput
                            key={variable.id}
                            variable={variable}
                            selectedValue={variables[variable.id]}
                            onChange={onVariableChange}
                        />
                    ))}
                </div>

                <div className="flex justify-between mt-8">
                    <button
                        onClick={onBack}
                        className="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out"
                    >
                        Back
                    </button>
                    <button
                        onClick={onCalculate}
                        className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105"
                    >
                        Calculate Score
                    </button>
                </div>
            </div>
        );

        // VariableInput Component
        const VariableInput = ({ variable, selectedValue, onChange }) => {
            const [showDetails, setShowDetails] = React.useState(false);

            return (
                <div className="mb-6 p-4 border border-gray-200 rounded-lg shadow-sm bg-white">
                    <div className="flex justify-between items-center mb-2">
                        <label className="block text-gray-700 text-lg font-medium">
                            {variable.name}
                            <span className="text-sm text-gray-500 ml-2">({variable.evidence})</span>
                        </label>
                        {variable.description && (
                            <button
                                onClick={() => setShowDetails(!showDetails)}
                                className="bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm font-semibold py-1 px-3 rounded-full transition duration-200 ease-in-out"
                            >
                                {showDetails ? 'Hide' : 'Details'}
                            </button>
                        )}
                    </div>
                    {showDetails && variable.description && (
                        <div className="mt-2 p-3 bg-gray-50 border border-gray-100 rounded-md text-gray-600 text-sm">
                            {variable.description}
                        </div>
                    )}
                    <div className="flex flex-wrap gap-3 mt-3">
                        {variable.options.map(option => (
                            <button
                                key={option.value}
                                onClick={() => onChange(variable.id, option.value)}
                                className={`
                                    py-2 px-4 rounded-full border-2
                                    ${selectedValue === option.value
                                        ? 'bg-blue-500 text-white border-blue-600 shadow-md'
                                        : 'bg-gray-100 text-gray-700 border-gray-300 hover:bg-blue-100 hover:border-blue-400'
                                    }
                                    transition duration-200 ease-in-out text-sm text-center whitespace-normal break-words flex-grow
                                `}
                            >
                                {option.label} (+{option.points} pts)
                            </button>
                        ))}
                    </div>
                </div>
            );
        };
        
        // ScoringMethodologyModal Component
        const ScoringMethodologyModal = ({ onClose }) => (
            <div className="modal-overlay" onClick={onClose}>
                <div className="modal-content" onClick={e => e.stopPropagation()}>
                    <button onClick={onClose} className="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
                    <h2 className="text-2xl font-bold text-gray-800 mb-4">Scoring Methodology</h2>
                    <div className="text-left text-gray-700 space-y-4">
                        <p>The purpose of this scoring system is not to create an "official" validated score, but to translate the strength of association reported in the literature (e.g., Odds Ratio, Hazard Ratio) into a practical and clinically intuitive system, similar to other surgical scores like Charlson or EuroSCORE.</p>
                        
                        <div>
                            <h3 className="text-lg font-semibold text-gray-800 mb-2">Criteria for Point Assignment (0-3)</h3>
                            <ul className="list-disc list-inside space-y-2">
                                <li>
                                    <span className="font-semibold">Magnitude of Risk (OR/RR):</span> Factors with a strong association (OR/RR ≥2) were assigned +2 or +3 points. Factors with a moderate association (OR/RR ~1.5–1.9) received +1 point.
                                    <ul className="list-circle list-inside ml-6 mt-1 text-sm">
                                        <li>Pre-existing adjacent disc degeneration (RR 3.2–4.0) → <span className="font-bold">+3 points</span></li>
                                        <li>PI-LL Mismatch >10° (OR up to 10) → <span className="font-bold">+2 points</span></li>
                                        <li>Age >60 years (RR ~2.8) → <span className="font-bold">+2 points</span></li>
                                        <li>Smoking (OR ~1.3–1.5) → <span className="font-bold">+1 point</span></li>
                                    </ul>
                                </li>
                                <li>
                                    <span className="font-semibold">Consistency Across Studies:</span> Factors repeatedly identified across multiple high-quality studies and meta-analyses were prioritized (e.g., osteoporosis).
                                </li>
                                <li>
                                    <span className="font-semibold">Potential for Clinical Intervention:</span> Factors that are highly modifiable were weighted to emphasize their clinical importance and motivate intervention (e.g., BMI, smoking, surgical technique).
                                </li>
                            </ul>
                        </div>

                        <div>
                            <h3 className="text-lg font-semibold text-gray-800 mb-2">Translation to Risk Categories</h3>
                            <p>The risk categories are based on the cumulative incidence of ASD reported in the literature (6–20% over 5–10 years) and rates within specific subgroups:</p>
                             <ul className="list-disc list-inside space-y-1 mt-2">
                                <li><span className="font-bold">Low (0–6 points):</span> Corresponds to an estimated risk of ~5–10%. This typically includes younger patients, short fusions, and optimal surgical technique.</li>
                                <li><span className="font-bold">Moderate (7–12 points):</span> Corresponds to ~10–25% risk. This represents the majority of patient series with 2-level fusions, average age, and moderate comorbidities.</li>
                                <li><span className="font-bold">High (>12 points):</span> Corresponds to >25% risk. This reflects cases with multiple high-risk factors (e.g., long fusions, pre-existing degeneration, advanced age, sagittal mismatch).</li>
                            </ul>
                        </div>
                        
                        <div>
                            <h3 className="text-lg font-semibold text-gray-800 mb-2">Formal Validation Status</h3>
                            <p>This is an <span className="font-bold">interpretive model</span> based on a literature review, not a formally validated score like a preliminary nomogram. For comparison, Yu et al. (2024) published a validated nomogram for TLIF using BMI, T-score, adjacent degeneration, and disc height, achieving an AUC of ~0.8. Our model expands on this by including more variables (especially surgical ones) to create a practical, educational tool.</p>
                        </div>

                        <div>
                             <h3 className="text-lg font-semibold text-gray-800 mb-2">Conclusion</h3>
                            <p>The current weighting has a solid scientific basis and is robust for the educational and clinical support purposes of this application. Formal external validation would be required for it to be used as an official predictive tool.</p>
                        </div>
                    </div>
                </div>
            </div>
        );


        // ResultScreen Component
        const ResultScreen = ({
            riskScore,
            riskCategory,
            estimatedPercentage,
            recommendations,
            detailedRecommendations,
            isGeneratingDetailedRecommendations,
            onGenerateDetailedRecommendations,
            onBack,
            onExportPdf,
            onShareByEmail
        }) => {
            const [showMethodology, setShowMethodology] = React.useState(false);
            
            let progressBarColor = 'bg-gray-400';
            let textColor = 'text-gray-800';

            if (riskCategory === 'Low') {
                progressBarColor = 'bg-green-500';
                textColor = 'text-green-700';
            } else if (riskCategory === 'Moderate') {
                progressBarColor = 'bg-yellow-500';
                textColor = 'text-yellow-700';
            } else if (riskCategory === 'High') {
                progressBarColor = 'bg-red-500';
                textColor = 'text-red-700';
            }

            const maxScore = 25;
            const progressBarWidth = (riskScore / maxScore) * 100;

            return (
                <>
                    {showMethodology && <ScoringMethodologyModal onClose={() => setShowMethodology(false)} />}
                    <div id="result-content" className="p-4">
                        <h2 className="text-2xl font-semibold text-gray-800 mb-6 text-center rounded-md">ASD Risk Calculation Result</h2>

                        <div className="mb-6 p-4 border border-gray-200 rounded-lg shadow-sm bg-white text-center">
                            <p className="text-xl font-bold text-gray-700 mb-2">Total Risk Score:</p>
                            <p className={`text-5xl font-extrabold ${textColor}`}>{riskScore}</p>
                            <p className="text-xl font-bold text-gray-700 mt-4 mb-2">Risk Category:</p>
                            <p className={`text-3xl font-extrabold ${textColor}`}>{riskCategory}</p>
                            <p className="text-lg text-gray-600 mt-2">Estimated 5-year Risk Percentage: <span className="font-semibold">{estimatedPercentage}</span></p>

                            <div className="w-full bg-gray-200 rounded-full h-4 mt-6">
                                <div
                                    className={`${progressBarColor} h-4 rounded-full transition-all duration-500 ease-in-out`}
                                    style={{ width: `${progressBarWidth}%` }}
                                ></div>
                            </div>
                        </div>

                        <div className="mb-6 p-4 border border-gray-200 rounded-lg shadow-sm bg-white">
                            <div className="flex flex-col sm:flex-row justify-between items-center mb-3 gap-2">
                                <h3 className="text-xl font-medium text-blue-600">Personalized Recommendations:</h3>
                                <button
                                    onClick={onGenerateDetailedRecommendations}
                                    disabled={isGeneratingDetailedRecommendations}
                                    className={`
                                        bg-purple-500 text-white font-bold py-2 px-4 rounded-lg shadow-md
                                        transition duration-300 ease-in-out transform hover:scale-105
                                        ${isGeneratingDetailedRecommendations ? 'opacity-50 cursor-not-allowed' : ''}
                                    `}
                                >
                                    {isGeneratingDetailedRecommendations ? 'Generating...' : '✨ Generate Detailed Recommendations'}
                                </button>
                            </div>

                            {recommendations.length > 0 ? (
                                <ul className="list-disc list-inside text-gray-700 space-y-2">
                                    {recommendations.map((rec, index) => (
                                        <li key={index} className="flex items-start">
                                            <span className="text-green-500 mr-2">✅</span>
                                            <span>{rec}</span>
                                        </li>
                                    ))}
                                </ul>
                            ) : (
                                <p className="text-gray-600">No specific recommendations identified based on selected modifiable factors.</p>
                            )}

                            {detailedRecommendations && (
                                <div className="mt-6 pt-4 border-t border-gray-200">
                                    <h4 className="text-lg font-semibold text-gray-800 mb-2">Detailed Recommendations:</h4>
                                    <p className="text-gray-700 whitespace-pre-wrap">{detailedRecommendations}</p>
                                </div>
                            )}
                        </div>

                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mt-8">
                             <button
                                onClick={onBack}
                                className="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out"
                            >
                                Recalculate
                            </button>
                            <button
                                onClick={() => setShowMethodology(true)}
                                className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out"
                            >
                                Scoring Methodology
                            </button>
                            <button
                                onClick={onExportPdf}
                                className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out"
                            >
                                Export to PDF
                            </button>
                            <button
                                onClick={onShareByEmail}
                                className="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out"
                            >
                                Share by Email
                            </button>
                        </div>
                    </div>
                </>
            );
        };

        // Render the App component into the 'root' div
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
